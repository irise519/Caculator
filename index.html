<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRADESC - 成绩与GPA计算器</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@11.2.0/dist/js/shepherd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@11.2.0/dist/css/shepherd.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background-color: var(--card-bg); border: 1px solid var(--card-border); border-radius: 0.5rem; box-shadow: var(--card-shadow); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; text-align: center; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--primary-btn-bg); color: white; }
        .btn-primary:hover { background-color: var(--primary-btn-hover-bg); }
        .btn-secondary { background-color: var(--secondary-btn-bg); color: var(--secondary-btn-text); }
        .btn-secondary:hover { background-color: var(--secondary-btn-hover-bg); }
        .dark .btn-secondary { color: var(--secondary-btn-text); }
        .input { width: 100%; padding: 0.5rem; border: 1px solid var(--input-border); border-radius: 0.375rem; background-color: transparent; color: var(--text-color); }
        .input:focus { outline: none; border-color: var(--input-focus-border); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .tab { padding: 0.75rem 1rem; margin-bottom: -1px; border: 1px solid transparent; border-radius: 0.375rem 0.375rem 0 0; cursor: pointer; }
        .tab.active { border-color: var(--tab-active-border); border-bottom-color: transparent; font-weight: 500; }
        .tab:not(.active) { color: var(--tab-inactive-text); }
        .highlight { background-color: var(--highlight-bg); color: var(--highlight-text); padding: 0.125rem 0.25rem; border-radius: 0.125rem; }
        .error-message { margin-bottom: 0.5rem; padding: 0.75rem; border-radius: 0.375rem; }
        .dark .error-message { border-color: #f87171; }
        .shepherd-modal { --shepherd-modal-z-index: 1000; }
        .shepherd-element { background-color: var(--card-bg) !important; border: 1px solid var(--card-border) !important; border-radius: 0.5rem !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important; }
        .shepherd-title { color: var(--header-text) !important; font-size: 1.25rem !important; font-weight: 600 !important; }
        .shepherd-text { color: var(--muted-text) !important; }
        .shepherd-footer { padding: 1rem !important; border-top: 1px solid var(--card-border) !important; }
        .shepherd-cancel-icon { color: var(--muted-text) !important; }
        .shepherd-cancel-icon:hover { color: var(--text-color) !important; }
        .shepherd-button.shepherd-button-secondary { background: var(--secondary-btn-bg) !important; color: var(--secondary-btn-text) !important; }
        .shepherd-button.shepherd-button-secondary:hover { background: var(--secondary-btn-hover-bg) !important; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 dark:bg-gray-900 dark:bg-opacity-80 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
    </div>
    <div id="error-container" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>
    <div id="login-view" class="max-w-md mx-auto text-center mt-20 fade-in">
        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 dark:text-gray-100">GRADESC</h1>
        <p class="mt-4 text-lg text-gray-600 dark:text-gray-300">您的智能成绩与GPA管理助手</p>
        <button id="google-login-btn" class="mt-8 btn btn-primary">使用 Google 账号登录</button>
    </div>
    <div id="app-view" class="hidden">
        <header class="flex flex-wrap items-center justify-between mb-6 gap-4">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold text-header-text">GRADESC</h1>
                <div class="relative">
                    <button id="student-menu-btn" class="flex items-center space-x-1 text-sm font-medium text-muted-text hover:text-header-text">
                        <span id="current-student-name-display">选择学生</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                    <div id="student-menu-options" class="absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 hidden z-10">
                        <ul id="student-options-list" class="py-1"></ul>
                        <div class="border-t border-gray-200 dark:border-gray-700 py-1">
                            <button id="add-student-btn" class="text-gray-700 dark:text-gray-300 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left">添加学生</button>
                            <button id="manage-students-btn" class="text-gray-700 dark:text-gray-300 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left">管理学生</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">
                    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path id="light-path" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /><path id="dark-path" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" class="hidden"/></svg>
                </button>
                <div class="relative">
                    <button id="user-menu-btn" class="flex items-center space-x-1 text-sm font-medium text-muted-text hover:text-header-text">
                        <span id="user-display-name">用户</span>
                        <img id="user-avatar" class="h-8 w-8 rounded-full" src="" alt="头像">
                    </button>
                    <div id="user-menu-options" class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 hidden z-10">
                        <div class="py-1">
                            <a href="#" id="export-json-btn" class="text-gray-700 dark:text-gray-300 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">备份为 JSON</a>
                            <a href="#" id="export-xlsx" class="text-gray-700 dark:text-gray-300 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">导出为 Excel (.xlsx)</a>
                            <a href="#" id="import-json-btn" class="text-gray-700 dark:text-gray-300 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">从 JSON 还原...</a>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-700 py-1">
                            <a href="#" id="logout-btn" class="text-gray-700 dark:text-gray-300 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">退出登录</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div class="mb-6">
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="flex space-x-8" id="tab-nav">
                        <button class="tab active" data-tab="courses">课程与成绩</button>
                        <button class="tab" data-tab="analytics">图表分析</button>
                        <button class="tab" data-tab="gpa">GPA 计算</button>
                    </nav>
                </div>
            </div>

            <div id="tab-content">
                <div id="courses-tab" class="tab-pane active">
                    <div class="flex flex-wrap gap-4 mb-6">
                        <input type="text" id="search-input" placeholder="搜索课程..." class="input flex-grow min-w-48">
                        <button id="add-semester-btn" class="btn btn-primary whitespace-nowrap">添加学期</button>
                    </div>
                    <div id="status-message" class="mb-4 text-sm text-muted-text"></div>
                    <div id="student-content-container" class="space-y-6"></div>
                    <div id="courses-empty-state" class="text-center py-12 text-muted-text">
                        <svg class="mx-auto h-12 w-12 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        <h3 class="mt-2 text-lg font-medium">暂无课程</h3>
                        <p class="mt-1">点击“添加学期”开始记录您的课程和成绩。</p>
                    </div>
                </div>

                <div id="analytics-tab" class="tab-pane hidden">
                    <div id="analytics-content" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-4">
                            <h3 class="text-lg font-medium mb-4 text-header-text">课程成绩表现</h3>
                            <canvas id="radar-chart" height="200"></canvas>
                        </div>
                        <div class="card p-4">
                            <h3 class="text-lg font-medium mb-4 text-header-text">成绩等级分布</h3>
                            <canvas id="bar-chart" height="200"></canvas>
                        </div>
                    </div>
                    <div id="analytics-empty-state" class="text-center py-12 text-muted-text">
                        <svg class="mx-auto h-12 w-12 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                        <h3 class="mt-2 text-lg font-medium">暂无分析数据</h3>
                        <p class="mt-1">请先添加学生和课程成绩。</p>
                    </div>
                </div>

                <div id="gpa-tab" class="tab-pane hidden">
                    <div class="card p-6">
                        <h2 class="text-xl font-bold mb-4 text-header-text">GPA 计算器</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium mb-3 text-header-text">手动输入</h3>
                                <div class="space-y-3" id="gpa-inputs">
                                    <div class="flex space-x-2">
                                        <input type="number" placeholder="学分" step="0.5" class="input w-20 gpa-credit">
                                        <input type="number" placeholder="分数" min="0" max="100" class="input flex-grow gpa-score">
                                        <button class="btn btn-secondary remove-gpa-row">-</button>
                                    </div>
                                </div>
                                <button id="add-gpa-row" class="btn btn-secondary mt-2">+ 添加课程</button>
                                <button id="calculate-gpa" class="btn btn-primary mt-4">计算 GPA</button>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-3 text-header-text">计算结果</h3>
                                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                                    <p><strong>总学分:</strong> <span id="total-credits">0</span></p>
                                    <p><strong>加权总分:</strong> <span id="weighted-score">0</span></p>
                                    <p><strong>平均分:</strong> <span id="average-score">0</span></p>
                                    <p class="text-xl font-bold mt-2"><strong>GPA:</strong> <span id="gpa-result" class="highlight">0.00</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 模态框 -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="card p-6 max-w-md w-full fade-in">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4 text-header-text">确认操作</h3>
            <p id="confirm-modal-body" class="mb-8 text-muted-text">您确定要继续吗？</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-modal-cancel-btn" class="btn btn-secondary">取消</button>
                <button id="confirm-modal-confirm-btn" class="btn btn-danger">确认</button>
            </div>
        </div>
    </div>

    <div id="import-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="card p-8 max-w-2xl w-full fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-header-text">从 JSON 还原数据</h2>
                <button onclick="document.getElementById('import-modal').style.display='none'" class="text-muted-text hover:text-header-text">&times;</button>
            </div>
            <p class="mb-4 text-muted-text">请选择您之前备份的 JSON 文件进行还原。此操作将覆盖当前所有数据，请谨慎操作。</p>
            <input type="file" id="import-json-file-input" accept=".json" class="mb-4">
            <div class="flex justify-end space-x-4">
                <button onclick="document.getElementById('import-modal').style.display='none'" class="btn btn-secondary">取消</button>
                <button id="import-json-confirm-btn" class="btn btn-primary">确认还原</button>
            </div>
        </div>
    </div>

    <script type="module">
        try {
            // Firebase 初始化
            const firebaseConfig = {
                apiKey: "AIzaSyBgYSM_HCYqUSvIN5VifHbX-j9p6IjhVJs",
                authDomain: "sample-firebase-ai-app-87f8f.firebaseapp.com",
                projectId: "sample-firebase-ai-app-87f8f",
                storageBucket: "sample-firebase-ai-app-87f8f.firebasestorage.app",
                messagingSenderId: "887928734431",
                appId: "1:887928734431:web:348a48ea1cde4a932cdf6a"
            };
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // ✅ 修复：添加这两行以注册 Chart.js 的 Doughnut 图表
            const { registerables } = await import("https://cdn.jsdelivr.net/npm/chart.js");
            Chart.register(...registerables);

            // === 状态与UI元素 ===
            let currentUser = null;
            let localStudentsData = [];
            let selectedStudentId = null;
            let chartInstances = {};
            const ui = {
                loginView: document.getElementById('login-view'),
                appView: document.getElementById('app-view'),
                loadingOverlay: document.getElementById('loading-overlay'),
                errorContainer: document.getElementById('error-container'),
                statusMessage: document.getElementById('status-message'),
                tabNav: document.getElementById('tab-nav'),
                tabContent: document.getElementById('tab-content'),
                coursesTab: document.getElementById('courses-tab'),
                analyticsTab: document.getElementById('analytics-tab'),
                gpaTab: document.getElementById('gpa-tab'),
                studentContentContainer: document.getElementById('student-content-container'),
                searchInput: document.getElementById('search-input'),
                addSemesterBtn: document.getElementById('add-semester-btn'),
                coursesEmptyState: document.getElementById('courses-empty-state'),
                analyticsContent: document.getElementById('analytics-content'),
                analyticsEmptyState: document.getElementById('analytics-empty-state'),
                radarChart: document.getElementById('radar-chart'),
                barChart: document.getElementById('bar-chart'),
                calculateGpaBtn: document.getElementById('calculate-gpa'),
                gpaInputs: document.getElementById('gpa-inputs'),
                addGpaRowBtn: document.getElementById('add-gpa-row'),
                totalCredits: document.getElementById('total-credits'),
                weightedScore: document.getElementById('weighted-score'),
                averageScore: document.getElementById('average-score'),
                gpaResult: document.getElementById('gpa-result'),
                themeToggle: document.getElementById('theme-toggle'),
                themeIcon: document.getElementById('theme-icon'),
                lightPath: document.getElementById('light-path'),
                darkPath: document.getElementById('dark-path'),
                studentMenu: {
                    btn: document.getElementById('student-menu-btn'),
                    options: document.getElementById('student-menu-options'),
                    list: document.getElementById('student-options-list'),
                    currentName: document.getElementById('current-student-name-display'),
                    addBtn: document.getElementById('add-student-btn'),
                    manageBtn: document.getElementById('manage-students-btn')
                },
                userMenu: {
                    btn: document.getElementById('user-menu-btn'),
                    options: document.getElementById('user-menu-options'),
                    displayName: document.getElementById('user-display-name'),
                    avatar: document.getElementById('user-avatar')
                },
                confirmModal: {
                    el: document.getElementById('confirm-modal'),
                    title: document.getElementById('confirm-modal-title'),
                    body: document.getElementById('confirm-modal-body'),
                    cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
                    confirmBtn: document.getElementById('confirm-modal-confirm-btn')
                },
                importModal: {
                    el: document.getElementById('import-modal'),
                    fileInput: document.getElementById('import-json-file-input'),
                    confirmBtn: document.getElementById('import-json-confirm-btn')
                },
                exportJsonBtn: document.getElementById('export-json-btn'),
                exportXlsxBtn: document.getElementById('export-xlsx'),
                importJsonBtn: document.getElementById('import-json-btn'),
                logoutBtn: document.getElementById('logout-btn'),
                googleLoginBtn: document.getElementById('google-login-btn')
            };

            // === 工具函数 ===
            function showError(message, details = null) {
                const errorId = `error-${Date.now()}`;
                const errorDiv = document.createElement('div');
                errorDiv.id = errorId;
                errorDiv.className = 'error-message mb-2 fade-in bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative';
                errorDiv.innerHTML = `<strong class="font-bold">错误:</strong><span class="block sm:inline"> ${message}</span>${details ? `<div class="mt-2 text-sm">${details}</div>` : ''}<span class="absolute top-0 bottom-0 right-0 px-4 py-3"><svg onclick="document.getElementById('${errorId}').remove()" class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.818l-2.651 3.031a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg></span>`;
                ui.errorContainer.appendChild(errorDiv);
                setTimeout(() => { errorDiv.remove(); }, 6000);
            }

            function showSuccess(message) {
                const successId = `success-${Date.now()}`;
                const successDiv = document.createElement('div');
                successDiv.id = successId;
                successDiv.className = 'fade-in p-4 mb-2 rounded-lg bg-green-50 border border-green-200 text-green-800 dark:bg-green-900/30 dark:border-green-700 dark:text-green-300';
                successDiv.innerHTML = `<div class="flex justify-between items-center"><span><strong>成功:</strong> ${message}</span><button onclick="document.getElementById('${successId}').remove()" class="text-lg font-bold text-green-600">&times;</button></div>`;
                ui.errorContainer.appendChild(successDiv);
                setTimeout(() => { successDiv.remove(); }, 3000);
            }

            function scoreToGpaPoint(score) {
                if (score >= 90) return 4.0; if (score >= 85) return 3.7; if (score >= 82) return 3.3;
                if (score >= 78) return 3.0; if (score >= 75) return 2.7; if (score >= 72) return 2.3;
                if (score >= 68) return 2.0; if (score >= 64) return 1.5; if (score >= 60) return 1.0;
                return 0.0;
            }

            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            const debouncedUpdater = debounce(() => {
                const student = localStudentsData.find(s => s.id === selectedStudentId);
                if (student) updateStudentData(student.semesters);
            }, 500);

            function showEmptyState(container, { title, message }) {
                container.querySelector('h3').textContent = title;
                container.querySelector('p').textContent = message;
            }

            // === 核心功能函数 ===
            function updateAllCalculations(student) {
                if (!student) return null;
                const studentCopy = JSON.parse(JSON.stringify(student));
                studentCopy.semesters.forEach(semester => {
                    let totalCredits = 0;
                    let weightedScoreSum = 0;
                    let gpaPointsSum = 0;
                    (semester.courses || []).forEach(course => {
                        const credits = parseFloat(course.credits) || 0;
                        totalCredits += credits;
                        let currentWeightedScore = 0;
                        (course.assignments || []).forEach(a => {
                            if (a.score !== '' && a.score !== null && a.score !== undefined) {
                                const score = parseFloat(a.score) || 0;
                                const maxScore = parseFloat(a.maxScore) || 100;
                                const weight = parseFloat(a.weight) || 0;
                                currentWeightedScore += (score / maxScore) * weight;
                            }
                        });
                        course.finalGrade = parseFloat(currentWeightedScore.toFixed(2));
                        const gpaPoint = scoreToGpaPoint(course.finalGrade);
                        gpaPointsSum += gpaPoint * credits;
                        weightedScoreSum += course.finalGrade * credits;
                    });
                    semester.totalCredits = totalCredits;
                    semester.gpa = totalCredits > 0 ? parseFloat((gpaPointsSum / totalCredits).toFixed(2)) : 0;
                    semester.averageScore = totalCredits > 0 ? parseFloat((weightedScoreSum / totalCredits).toFixed(2)) : 0;
                });
                const allCourses = studentCopy.semesters.flatMap(s => s.courses || []);
                const overallTotalCredits = allCourses.reduce((sum, c) => sum + (parseFloat(c.credits) || 0), 0);
                const overallGpaPointsSum = allCourses.reduce((sum, c) => {
                    const credits = parseFloat(c.credits) || 0;
                    return sum + scoreToGpaPoint(c.finalGrade) * credits;
                }, 0);
                const overallWeightedScoreSum = allCourses.reduce((sum, c) => sum + (c.finalGrade * (parseFloat(c.credits) || 0)), 0);
                studentCopy.overallGpa = overallTotalCredits > 0 ? parseFloat((overallGpaPointsSum / overallTotalCredits).toFixed(2)) : 0;
                studentCopy.overallAverageScore = overallTotalCredits > 0 ? parseFloat((overallWeightedScoreSum / overallTotalCredits).toFixed(2)) : 0;
                return studentCopy;
            }

            function renderStudentSelector() {
                ui.studentMenu.list.innerHTML = '';
                localStudentsData.forEach(student => {
                    const li = document.createElement('li');
                    li.className = 'px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-sm';
                    li.textContent = student.name;
                    li.dataset.studentId = student.id;
                    li.addEventListener('click', () => {
                        selectedStudentId = student.id;
                        localStorage.setItem('selectedStudentId', student.id);
                        ui.studentMenu.currentName.textContent = student.name;
                        ui.studentMenu.options.classList.add('hidden');
                        renderApp(ui.searchInput.value);
                    });
                    ui.studentMenu.list.appendChild(li);
                });
                const currentStudent = localStudentsData.find(s => s.id === selectedStudentId);
                ui.studentMenu.currentName.textContent = currentStudent ? currentStudent.name : '选择学生';
            }

            function renderEmptyStates(student) {
                const hasSemesters = student && student.semesters && student.semesters.length > 0;
                ui.coursesEmptyState.classList.toggle('hidden', hasSemesters);
                ui.studentContentContainer.classList.toggle('hidden', !hasSemesters);
            }

            function renderStudentContent(student, searchTerm = '') {
                ui.studentContentContainer.innerHTML = '';
                const filteredSemesters = student.semesters.filter(semester =>
                    semester.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (semester.courses || []).some(course =>
                        course.name.toLowerCase().includes(searchTerm.toLowerCase())
                    )
                );
                filteredSemesters.forEach((semester, semIndex) => {
                    const semesterEl = document.createElement('div');
                    semesterEl.className = 'card p-6';
                    semesterEl.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <button class="drag-handle text-muted-text hover:text-header-text cursor-move">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                                </button>
                                <h2 class="text-xl font-semibold text-header-text">${semester.name}</h2>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-muted-text">总学分: ${semester.totalCredits || 0}</span>
                                <span class="text-sm text-muted-text">平均分: ${semester.averageScore || 0}</span>
                                <span class="text-sm font-medium text-highlight-text">GPA: ${semester.gpa || 0}</span>
                                <button class="text-red-500 hover:text-red-700" onclick="deleteSemester('${semester.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-4" id="courses-${semester.id}">
                            ${(semester.courses || []).map((course, courseIndex) => `
                                <div class="border-l-4 border-indigo-500 pl-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h3 class="font-medium text-header-text">${course.name} <span class="text-sm text-muted-text">(${course.credits || 0} 学分)</span></h3>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm text-muted-text">最终: ${course.finalGrade || 0}</span>
                                            <button class="text-red-500 hover:text-red-700" onclick="deleteCourse('${semester.id}', '${course.id}')">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                                            <h4 class="text-sm font-medium mb-2 text-header-text">作业列表</h4>
                                            <div class="space-y-2" id="assignments-${course.id}">
                                                ${(course.assignments || []).map((a, aIndex) => `
                                                    <div class="flex items-center space-x-2">
                                                        <input type="text" value="${a.name || ''}" placeholder="作业名" class="input text-sm w-24" onchange="updateAssignment('${semester.id}', '${course.id}', ${aIndex}, 'name', this.value)">
                                                        <input type="number" value="${a.maxScore || 100}" placeholder="满分" class="input text-sm w-20" onchange="updateAssignment('${semester.id}', '${course.id}', ${aIndex}, 'maxScore', this.valueAsNumber)">
                                                        <input type="number" value="${a.score || ''}" placeholder="得分" class="input text-sm w-20" onchange="updateAssignment('${semester.id}', '${course.id}', ${aIndex}, 'score', this.valueAsNumber)">
                                                        <input type="number" value="${a.weight || 0}" placeholder="权重%" class="input text-sm w-20" onchange="updateAssignment('${semester.id}', '${course.id}', ${aIndex}, 'weight', this.valueAsNumber)">
                                                        <button class="text-red-500 hover:text-red-700" onclick="deleteAssignment('${semester.id}', '${course.id}', ${aIndex})">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                                        </button>
                                                    </div>
                                                `).join('')}
                                                <button class="btn btn-secondary text-sm mt-2" onclick="addAssignment('${semester.id}', '${course.id}')">+ 添加作业</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-center">
                                            <canvas id="doughnut-${course.id}" width="120" height="120"></canvas>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            <button class="btn btn-secondary text-sm" onclick="addCourse('${semester.id}')">+ 添加课程</button>
                        </div>
                    `;
                    ui.studentContentContainer.appendChild(semesterEl);

                    // 为每个课程渲染环形图
                    (semester.courses || []).forEach(course => {
                        const canvas = document.getElementById(`doughnut-${course.id}`);
                        if (canvas) {
                            renderCourseWeightDoughnutChart(canvas, course);
                        }
                    });
                });
            }

            function renderOverallUI(student) {
                const gpaDisplay = document.getElementById('gpa-display');
                if (gpaDisplay) {
                    if (student) {
                        gpaDisplay.innerHTML = `<p class="text-center">整体 GPA: <span class="highlight">${student.overallGpa}</span> | 整体平均分: <span class="highlight">${student.overallAverageScore}</span></p>`;
                    } else {
                        gpaDisplay.innerHTML = '<p class="text-center text-muted-text">暂无学生数据</p>';
                    }
                }
            }

            function renderCourseWeightDoughnutChart(canvas, course) {
                const chartId = `doughnut-${course.id}`;
                if (chartInstances[chartId]) chartInstances[chartId].destroy();

                const ctx = canvas.getContext('2d');
                const weights = (course.assignments || []).map(a => parseFloat(a.weight) || 0);
                const labels = (course.assignments || []).map(a => a.name || '未命名');
                const totalWeight = weights.reduce((a, b) => a + b, 0);
                const data = weights;
                const isDark = document.documentElement.classList.contains('dark');
                const chartBorderColor = isDark ? '#1f2937' : '#f3f4f6';

                const colors = [
                    'rgba(59, 130, 246, 0.8)', // blue
                    'rgba(16, 185, 129, 0.8)', // green
                    'rgba(245, 158, 11, 0.8)', // amber
                    'rgba(239, 68, 68, 0.8)', // red
                    'rgba(139, 92, 246, 0.8)'  // purple
                ];

                chartInstances[chartId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '权重',
                            data: data,
                            backgroundColor: colors.concat(['#6b7280']),
                            borderWidth: 3,
                            borderColor: chartBorderColor
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                display: false,
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => ` ${context.label}: ${context.parsed.toFixed(1)}%`
                                }
                            },
                            title: {
                                display: true,
                                text: '作业权重分布',
                                color: isDark ? '#f9fafb' : '#111827',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                });
            }

            function renderCoursePerformanceRadarChart(canvas, studentData) {
                const chartId = 'radar-chart';
                if (chartInstances[chartId]) chartInstances[chartId].destroy();
                const ctx = canvas.getContext('2d');
                const labels = [];
                const data = [];
                studentData.semesters.forEach(s => {
                    (s.courses || []).forEach(c => {
                        labels.push(c.name || '未命名课程');
                        data.push(c.finalGrade);
                    });
                });
                if (labels.length < 3) { return; }
                const isDark = document.documentElement.classList.contains('dark');
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
                const textColor = isDark ? '#e5e7eb' : '#6b7280';
                const pointLabelColor = isDark ? '#f9fafb' : '#111827';
                chartInstances[chartId] = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '课程最终成绩',
                            data: data,
                            fill: true,
                            backgroundColor: 'rgba(79, 70, 229, 0.2)',
                            borderColor: 'rgb(79, 70, 229)',
                            pointBackgroundColor: 'rgb(79, 70, 229)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(79, 70, 229)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                grid: { color: gridColor },
                                ticks: { color: textColor, backdropColor: 'transparent' },
                                pointLabels: { color: pointLabelColor, font: { size: 12 } }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: '课程成绩表现',
                                color: isDark ? '#f9fafb' : '#111827',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                });
            }

            function renderGradeCreditDistributionBarChart(canvas, studentData) {
                const chartId = 'bar-chart';
                if (chartInstances[chartId]) chartInstances[chartId].destroy();
                const ctx = canvas.getContext('2d');
                const gradeCredits = { A: 0, B: 0, C: 0, D: 0, F: 0 };
                studentData.semesters.forEach(s => {
                    (s.courses || []).forEach(c => {
                        const credits = parseFloat(c.credits) || 0;
                        const grade = c.finalGrade;
                        if (grade >= 90) gradeCredits.A += credits;
                        else if (grade >= 80) gradeCredits.B += credits;
                        else if (grade >= 70) gradeCredits.C += credits;
                        else if (grade >= 60) gradeCredits.D += credits;
                        else gradeCredits.F += credits;
                    });
                });
                const isDark = document.documentElement.classList.contains('dark');
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
                const textColor = isDark ? '#e5e7eb' : '#6b7280';
                chartInstances[chartId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(gradeCredits),
                        datasets: [{
                            label: '权重',
                            data: Object.values(gradeCredits),
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(59, 130, 246, 0.7)',
                                'rgba(245, 158, 11, 0.7)',
                                'rgba(239, 68, 68, 0.7)',
                                'rgba(107, 114, 128, 0.7)'
                            ],
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            y: { grid: { display: false }, ticks: { color: textColor } },
                            x: { grid: { color: gridColor }, ticks: { color: textColor } }
                        },
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: '成绩等级分布 (按学分)',
                                color: isDark ? '#f9fafb' : '#111827',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                });
            }

            function renderAnalyticsTab(student) {
                if (!student || !student.semesters || student.semesters.length === 0) {
                    ui.analyticsContent.classList.add('hidden');
                    showEmptyState(ui.analyticsEmptyState, { title: '无数据可供分析', message: '请先添加学生和课程成绩。' });
                    return;
                }
                ui.analyticsContent.classList.remove('hidden');
                ui.analyticsEmptyState.classList.add('hidden');
                renderCoursePerformanceRadarChart(ui.radarChart, student);
                renderGradeCreditDistributionBarChart(ui.barChart, student);
            }

            function setupEventListeners() {
                // 标签页切换
                ui.tabNav.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab')) {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
                        e.target.classList.add('active');
                        const tabId = e.target.dataset.tab;
                        document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                        if (tabId === 'analytics') {
                            const student = localStudentsData.find(s => s.id === selectedStudentId);
                            renderAnalyticsTab(student);
                        }
                    }
                });

                // 搜索
                ui.searchInput.addEventListener('input', (e) => {
                    renderApp(e.target.value);
                });

                // 添加学期
                ui.addSemesterBtn.addEventListener('click', async () => {
                    const student = localStudentsData.find(s => s.id === selectedStudentId);
                    if (!student) return;
                    const name = prompt('请输入学期名称:', `学期 ${student.semesters.length + 1}`);
                    if (!name || !name.trim()) return;
                    const newSemester = { id: `sem-${Date.now()}`, name: name.trim(), courses: [], order: student.semesters.length };
                    student.semesters.push(newSemester);
                    await updateStudentData(student.semesters);
                });

                // 添加课程
                window.addCourse = async (semesterId) => {
                    const student = localStudentsData.find(s => s.id === selectedStudentId);
                    if (!student) return;
                    const semester = student.semesters.find(s => s.id === semesterId);
                    if (!semester) return;
                    const name = prompt('请输入课程名称:');
                    if (!name || !name.trim()) return;
                    const credits = parseFloat(prompt('请输入学分:', '3')) || 3;
                    const newCourse = { id: `course-${Date.now()}`, name: name.trim(), credits: credits, assignments: [], order: (semester.courses || []).length };
                    if (!semester.courses) semester.courses = [];
                    semester.courses.push(newCourse);
                    await updateStudentData(student.semesters);
                };

                // 添加作业
                window.addAssignment = async (semesterId, courseId) => {
                    const student = localStudentsData.find(s => s.id === selectedStudentId);
                    if (!student) return;
                    const semester = student.semesters.find(s => s.id === semesterId);
                    if (!semester) return;
                    const course = (semester.courses || []).find(c => c.id === courseId);
                    if (!course) return;
                    const name = prompt('请输入作业名称:', `作业 ${course.assignments.length + 1}`);
                    if (!name || !name.trim()) return;
                    const maxScore = parseFloat(prompt('满分是多少?', '100')) || 100;
                    const weight = parseFloat(prompt('此项作业占总成绩的百分比?', '10')) || 0;
                    course.assignments.push({ name: name.trim(), maxScore, weight, score: '' });
                    await updateStudentData(student.semesters);
                };

                // 更新作业
                window.updateAssignment = async (semesterId, courseId, assignmentIndex, field, value) => {
                    const student = localStudentsData.find(s => s.id === selectedStudentId);
                    if (!student) return;
                    const semester = student.semesters.find(s => s.id === semesterId);
                    if (!semester) return;
                    const course = (semester.courses || []).find(c => c.id === courseId);
                    if (!course || !course.assignments[assignmentIndex]) return;
                    course.assignments[assignmentIndex][field] = value;
                    debouncedUpdater();
                };

                // 删除作业
                window.deleteAssignment = async (semesterId, courseId, assignmentIndex) => {
                    if (!confirm('确定要删除这项作业吗？')) return;
                    const student = localStudentsData.find(s => s.id === selectedStudentId);
                    if (!student) return;
                    const semester = student.semesters.find(s => s.id === semesterId);
                    if (!semester) return;
                    const course = (semester.courses || []).find(c => c.id === courseId);
                    if (!course) return;
                    course.assignments.splice(assignmentIndex, 1);
                    await updateStudentData(student.semesters);
                };

                // 删除课程
                window.deleteCourse = async (semesterId, courseId) => {
                    if (!confirm('确定要删除这门课程吗？这将删除所有相关作业。')) return;
                    const student = localStudentsData.find(s => s.id === selectedStudentId);
                    if (!student) return;
                    const semester = student.semesters.find(s => s.id === semesterId);
                    if (!semester || !semester.courses) return;
                    semester.courses = semester.courses.filter(c => c.id !== courseId);
                    await updateStudentData(student.semesters);
                };

                // 删除学期
                window.deleteSemester = async (semesterId) => {
                    if (!confirm('确定要删除这个学期吗？这将删除该学期下的所有课程和作业。')) return;
                    const student = localStudentsData.find(s => s.id === selectedStudentId);
                    if (!student) return;
                    student.semesters = student.semesters.filter(s => s.id !== semesterId);
                    await updateStudentData(student.semesters);
                };

                // 学生菜单
                ui.studentMenu.btn.addEventListener('click', () => {
                    ui.studentMenu.options.classList.toggle('hidden');
                });
                ui.studentMenu.addBtn.addEventListener('click', async () => {
                    const name = prompt('请输入新学生姓名:');
                    if (!name || !name.trim()) return;
                    try {
                        const studentDocRef = await addDoc(collection(db, 'users', currentUser.uid, 'students'), {
                            name: name.trim(),
                            semesters: [],
                            order: localStudentsData.length
                        });
                        showSuccess('学生添加成功');
                        ui.studentMenu.options.classList.add('hidden');
                    } catch (error) {
                        showError('添加学生失败', error.message);
                    }
                });
                ui.studentMenu.manageBtn.addEventListener('click', () => {
                    alert('管理学生功能待开发');
                    ui.studentMenu.options.classList.add('hidden');
                });

                // 用户菜单
                ui.userMenu.btn.addEventListener('click', () => {
                    ui.userMenu.options.classList.toggle('hidden');
                });

                // 主题切换
                ui.themeToggle.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    const isDark = document.documentElement.classList.contains('dark');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    ui.lightPath.classList.toggle('hidden');
                    ui.darkPath.classList.toggle('hidden');
                });

                // 登录/登出
                ui.googleLoginBtn.addEventListener('click', () => {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    auth.signInWithPopup(provider).catch(error => showError('登录失败', error.message));
                });
                ui.logoutBtn.addEventListener('click', () => {
                    auth.signOut().catch(error => showError('退出失败', error.message));
                });

                // GPA 计算器
                ui.addGpaRowBtn.addEventListener('click', () => {
                    const row = document.createElement('div');
                    row.className = 'flex space-x-2';
                    row.innerHTML = `
                        <input type="number" placeholder="学分" step="0.5" class="input w-20 gpa-credit">
                        <input type="number" placeholder="分数" min="0" max="100" class="input flex-grow gpa-score">
                        <button class="btn btn-secondary remove-gpa-row">-</button>
                    `;
                    row.querySelector('.remove-gpa-row').addEventListener('click', () => row.remove());
                    ui.gpaInputs.appendChild(row);
                });
                document.addEventListener('click', (e) => {
                    if (e.target && e.target.classList.contains('remove-gpa-row')) {
                        e.target.closest('div').remove();
                    }
                });
                ui.calculateGpaBtn.addEventListener('click', () => {
                    const rows = ui.gpaInputs.querySelectorAll(':scope > div');
                    let totalCredits = 0;
                    let weightedScoreSum = 0;
                    let gpaPointsSum = 0;
                    let valid = true;
                    rows.forEach(row => {
                        const creditInput = row.querySelector('.gpa-credit');
                        const scoreInput = row.querySelector('.gpa-score');
                        const credits = parseFloat(creditInput.value) || 0;
                        const score = parseFloat(scoreInput.value);
                        if (isNaN(score) || score < 0 || score > 100) {
                            valid = false;
                            scoreInput.classList.add('border-red-500');
                        } else {
                            scoreInput.classList.remove('border-red-500');
                        }
                        totalCredits += credits;
                        weightedScoreSum += score * credits;
                        gpaPointsSum += scoreToGpaPoint(score) * credits;
                    });
                    if (!valid) {
                        showError('请输入有效的分数 (0-100)');
                        return;
                    }
                    const averageScore = totalCredits > 0 ? (weightedScoreSum / totalCredits).toFixed(2) : 0;
                    const gpa = totalCredits > 0 ? (gpaPointsSum / totalCredits).toFixed(2) : 0;
                    ui.totalCredits.textContent = totalCredits.toFixed(1);
                    ui.weightedScore.textContent = weightedScoreSum.toFixed(2);
                    ui.averageScore.textContent = averageScore;
                    ui.gpaResult.textContent = gpa;
                });

                // 导入导出
                ui.exportJsonBtn.addEventListener('click', () => {
                    const student = localStudentsData.find(s => s.id === selectedStudentId);
                    if (!student) return;
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(student, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", `${student.name}_backup.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                });

                ui.exportXlsxBtn.addEventListener('click', () => {
                    const student = localStudentsData.find(s => s.id === selectedStudentId);
                    if (!student) return;
                    const wb = XLSX.utils.book_new();
                    student.semesters.forEach(semester => {
                        const ws_data = [
                            ['课程', '作业', '满分', '得分', '权重(%)', '最终成绩', '学分', 'GPA']
                        ];
                        (semester.courses || []).forEach(course => {
                            (course.assignments || []).forEach(a => {
                                ws_data.push([course.name, a.name, a.maxScore, a.score, a.weight]);
                            });
                            ws_data.push(['', '', '', '', '', course.finalGrade, course.credits, scoreToGpaPoint(course.finalGrade)]);
                        });
                        ws_data.push(['', '', '', '', '', '', '学期总学分:', semester.totalCredits]);
                        ws_data.push(['', '', '', '', '', '', '学期GPA:', semester.gpa]);
                        const ws = XLSX.utils.aoa_to_sheet(ws_data);
                        XLSX.utils.book_append_sheet(wb, ws, semester.name);
                    });
                    XLSX.writeFile(wb, `${student.name}_成绩表.xlsx`);
                });

                ui.importJsonBtn.addEventListener('click', () => {
                    ui.importModal.el.style.display = 'flex';
                    ui.importModal.fileInput.value = '';
                });

                ui.importModal.confirmBtn.addEventListener('click', async () => {
                    const file = ui.importModal.fileInput.files[0];
                    if (!file) {
                        showError('请选择一个文件');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            const student = localStudentsData.find(s => s.id === selectedStudentId);
                            if (!student) return;
                            const batch = writeBatch(db);
                            const studentDocRef = doc(db, 'users', currentUser.uid, 'students', selectedStudentId);
                            batch.update(studentDocRef, { semesters: jsonData.semesters });
                            await batch.commit();
                            showSuccess("JSON 数据导入成功！");
                            ui.importModal.el.style.display = 'none';
                        } catch (err) {
                            showError("JSON 文件解析失败或格式错误", err.message);
                        }
                    };
                    reader.readAsText(file);
                });

                // 其他事件监听器...
            }

            async function updateStudentData(updatedSemesters) {
                if (!selectedStudentId || !currentUser) return;
                updatedSemesters.forEach((s, s_idx) => {
                    s.id = s.id || `sem-${Date.now()}-${s_idx}`;
                    s.order = s_idx;
                    (s.courses || []).forEach((c, c_idx) => { c.order = c_idx; });
                });
                const studentDocRef = doc(db, 'users', currentUser.uid, 'students', selectedStudentId);
                try {
                    await updateDoc(studentDocRef, { semesters: updatedSemesters });
                } catch (error) {
                    showError('数据更新失败', error.message);
                }
            }

            function initSortable() {
                const semesterContainer = ui.studentContentContainer;
                if (semesterContainer) {
                    new Sortable(semesterContainer, {
                        animation: 150,
                        handle: '.drag-handle',
                        onEnd: (evt) => {
                            const student = localStudentsData.find(s => s.id === selectedStudentId);
                            if (!student) return;
                            const movedItem = student.semesters.splice(evt.oldIndex, 1)[0];
                            student.semesters.splice(evt.newIndex, 0, movedItem);
                            updateStudentData(student.semesters);
                        }
                    });
                }
            }

            function renderApp(searchTerm = '') {
                const student = localStudentsData.find(s => s.id === selectedStudentId);
                renderStudentSelector();
                renderEmptyStates(student);
                if (student) {
                    const studentWithCalculations = updateAllCalculations(student);
                    renderStudentContent(studentWithCalculations, searchTerm);
                    renderOverallUI(studentWithCalculations);
                } else {
                    ui.studentContentContainer.innerHTML = '';
                    renderOverallUI(null);
                }
            }

            // === 初始化 ===
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                ui.lightPath.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                ui.darkPath.classList.add('hidden');
            }

            // Firebase 认证状态监听
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    ui.loginView.classList.add('hidden');
                    ui.appView.classList.remove('hidden');
                    ui.userMenu.displayName.textContent = user.displayName || '用户';
                    ui.userMenu.avatar.src = user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || '用户');

                    // 从 localStorage 恢复选中的学生
                    const savedStudentId = localStorage.getItem('selectedStudentId');
                    const q = query(collection(db, 'users', user.uid, 'students'));
                    let studentsUnsubscribe = onSnapshot(q, (snapshot) => {
                        localStudentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        localStudentsData.sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));
                        if (!selectedStudentId || !localStudentsData.some(s => s.id === selectedStudentId)) {
                            selectedStudentId = savedStudentId && localStudentsData.some(s => s.id === savedStudentId) ? savedStudentId : localStudentsData[0]?.id || null;
                            if (selectedStudentId) {
                                localStorage.setItem('selectedStudentId', selectedStudentId);
                            }
                        }
                        renderApp();
                        ui.loadingOverlay.style.display = 'none';
                    }, (error) => {
                        showError('数据加载失败', error.message);
                        ui.loadingOverlay.style.display = 'none';
                    });

                } else {
                    ui.loginView.classList.remove('hidden');
                    ui.appView.classList.add('hidden');
                    localStudentsData = [];
                    selectedStudentId = null;
                    ui.loadingOverlay.style.display = 'none';
                }
            });

            setupEventListeners();
            initSortable();

        } catch (error) {
            console.error("初始化失败:", error);
            showError('应用初始化失败', error.message);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRADESC - 成绩与GPA计算器</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@11.2.0/dist/js/shepherd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@11.2.0/dist/css/shepherd.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background-color: var(--card-bg); border: 1px solid var(--card-border); border-radius: 0.5rem; box-shadow: var(--card-shadow); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; text-align: center; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--primary-btn-bg); color: white; }
        .btn-primary:hover { background-color: var(--primary-btn-hover-bg); }
        .btn-secondary { background-color: var(--secondary-btn-bg); color: var(--secondary-btn-text); }
        .btn-secondary:hover { background-color: var(--secondary-btn-hover-bg); }
        .dark .btn-secondary { color: var(--secondary-btn-text); }
        .input { width: 100%; padding: 0.5rem; border: 1px solid var(--input-border); border-radius: 0.375rem; background-color: transparent; color: var(--text-color); }
        .input:focus { outline: none; border-color: var(--input-focus-border); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .tab { padding: 0.75rem 1rem; margin-bottom: -1px; border: 1px solid transparent; border-radius: 0.375rem 0.375rem 0 0; cursor: pointer; }
        .tab.active { border-color: var(--tab-active-border); border-bottom-color: transparent; font-weight: 500; }
        .tab:not(.active) { color: var(--tab-inactive-text); }
        .highlight { background-color: var(--highlight-bg); color: var(--highlight-text); padding: 0.125rem 0.25rem; border-radius: 0.125rem; }
        .error-message { margin-bottom: 0.5rem; padding: 0.75rem; border-radius: 0.375rem; }
        .dark .error-message { border-color: #f87171; }
        .shepherd-modal { --shepherd-modal-z-index: 1000; }
        .shepherd-element { background-color: var(--card-bg) !important; border: 1px solid var(--card-border) !important; border-radius: 0.5rem !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important; }
        .shepherd-title { color: var(--header-text) !important; font-size: 1.25rem !important; font-weight: 600 !important; }
        .shepherd-text { color: var(--muted-text) !important; }
        .shepherd-footer { padding: 1rem !important; border-top: 1px solid var(--card-border) !important; }
        .shepherd-cancel-icon { color: var(--muted-text) !important; }
        .shepherd-cancel-icon:hover { color: var(--text-color) !important; }
        .shepherd-button.shepherd-button-secondary { background: var(--secondary-btn-bg) !important; color: var(--secondary-btn-text) !important; }
        .shepherd-button.shepherd-button-secondary:hover { background: var(--secondary-btn-hover-bg) !important; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 dark:bg-gray-900 dark:bg-opacity-80 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
    </div>
    <div id="error-container" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>
    <div id="login-view" class="max-w-md mx-auto text-center mt-20 fade-in">
        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 dark:text-gray-100">GRADESC</h1>
        <p class="mt-4 text-lg text-gray-600 dark:text-gray-300">您的智能成绩与GPA管理助手</p>
        <button id="google-login-btn" class="mt-8 btn btn-primary">使用 Google 账号登录</button>
    </div>
    <div id="app-view" class="hidden">
        <header class="flex flex-wrap items-center justify-between mb-6 gap-4">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold text-header-text">GRADESC</h1>
                <div class="relative">
                    <button id="student-menu-btn" class="flex items-center space-x-1 text-sm font-medium text-muted-text hover:text-header-text">
                        <span id="current-student-name-display">选择学生</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                    <div id="student-menu-options" class="absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 hidden z-10">
                        <ul id="student-options-list" class="py-1"></ul>
                        <div class="border-t border-gray-200 dark:border-gray-700 py-1">
                            <button id="add-student-btn" class="text-gray-700 dark:text-gray-300 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left">添加学生</button>
                            <button id="manage-students-btn" class="text-gray-700 dark:text-gray-300 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left">管理学生</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">
                    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path id="light-path" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /><path id="dark-path" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" class="hidden"/></svg>
                </button>
                <div class="relative">
                    <button id="user-menu-btn" class="flex items-center space-x-1 text-sm font-medium text-muted-text hover:text-header-text">
                        <span id="user-display-name">用户</span>
                        <img id="user-avatar" class="h-8 w-8 rounded-full" src="" alt="头像">
                    </button>
                    <div id="user-menu-options" class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 hidden z-10">
                        <div class="py-1">
                            <a href="#" id="export-json-btn" class="text-gray-700 dark:text-gray-300 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">备份为 JSON</a>
                            <a href="#" id="export-xlsx" class="text-gray-700 dark:text-gray-300 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">导出为 Excel (.xlsx)</a>
                            <a href="#" id="import-json-btn" class="text-gray-700 dark:text-gray-300 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">从 JSON 还原...</a>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-700 py-1">
                            <a href="#" id="logout-btn" class="text-gray-700 dark:text-gray-300 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">退出登录</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div class="mb-6">
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="flex space-x-8" id="tab-nav">
                        <button class="tab active" data-tab="courses">课程与成绩</button>
                        <button class="tab" data-tab="analytics">图表分析</button>
                        <button class="tab" data-tab="gpa">GPA 计算</button>
                    </nav>
                </div>
            </div>

            <div id="tab-content">
                <div id="courses-tab" class="tab-pane active">
                    <div class="flex flex-wrap gap-4 mb-6">
                        <input type="text" id="search-input" placeholder="搜索课程..." class="input flex-grow min-w-48">
                        <button id="add-semester-btn" class="btn btn-primary whitespace-nowrap">添加学期</button>
                    </div>
                    <div id="status-message" class="mb-4 text-sm text-muted-text"></div>
                    <div id="student-content-container" class="space-y-6"></div>
                    <div id="courses-empty-state" class="text-center py-12 text-muted-text">
                        <svg class="mx-auto h-12 w-12 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        <h3 class="mt-2 text-lg font-medium">暂无课程</h3>
                        <p class="mt-1">点击“添加学期”开始记录您的课程和成绩。</p>
                    </div>
                </div>

                <div id="analytics-tab" class="tab-pane hidden">
                    <div id="analytics-content" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-4">
                            <h3 class="text-lg font-medium mb-4 text-header-text">课程成绩表现</h3>
                            <canvas id="radar-chart" height="200"></canvas>
                        </div>
                        <div class="card p-4">
                            <h3 class="text-lg font-medium mb-4 text-header-text">成绩等级分布</h3>
                            <canvas id="bar-chart" height="200"></canvas>
                        </div>
                    </div>
                    <div id="analytics-empty-state" class="text-center py-12 text-muted-text">
                        <svg class="mx-auto h-12 w-12 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                        <h3 class="mt-2 text-lg font-medium">暂无分析数据</h3>
                        <p class="mt-1">请先添加学生和课程成绩。</p>
                    </div>
                </div>

                <div id="gpa-tab" class="tab-pane hidden">
                    <div class="card p-6">
                        <h2 class="text-xl font-bold mb-4 text-header-text">GPA 计算器</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium mb-3 text-header-text">手动输入</h3>
                                <div class="space-y-3" id="gpa-inputs">
                                    <div class="flex space-x-2">
                                        <input type="number" placeholder="学分" step="0.5" class="input w-20 gpa-credit">
                                        <input type="number" placeholder="分数" min="0" max="100" class="input flex-grow gpa-score">
                                        <button class="btn btn-secondary remove-gpa-row">-</button>
                                    </div>
                                </div>
                                <button id="add-gpa-row" class="btn btn-secondary mt-2">+ 添加课程</button>
                                <button id="calculate-gpa" class="btn btn-primary mt-4">计算 GPA</button>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-3 text-header-text">计算结果</h3>
                                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                                    <p><strong>总学分:</strong> <span id="total-credits">0</span></p>
                                    <p><strong>加权总分:</strong> <span id="weighted-score">0</span></p>
                                    <p><strong>平均分:</strong> <span id="average-score">0</span></p>
                                    <p class="text-xl font-bold mt-2"><strong>GPA:</strong> <span id="gpa-result" class="highlight">0.00</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="card p-6 max-w-md w-full fade-in">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4 text-header-text">确认操作</h3>
            <p id="confirm-modal-body" class="mb-8 text-muted-text">您确定要继续吗？</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-modal-cancel-btn" class="btn btn-secondary">取消</button>
                <button id="confirm-modal-confirm-btn" class="btn btn-danger">确认</button>
            </div>
        </div>
    </div>

    <div id="import-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="card p-8 max-w-2xl w-full fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-header-text">从 JSON 还原数据</h2>
                <button onclick="document.getElementById('import-modal').style.display='none'" class="text-muted-text hover:text-header-text">&times;</button>
            </div>
            <p class="mb-4 text-muted-text">请选择您之前备份的 JSON 文件进行还原。此操作将覆盖当前所有数据，请谨慎操作。</p>
            <input type="file" id="import-json-file-input" accept=".json" class="mb-4">
            <div class="flex justify-end space-x-4">
                <button onclick="document.getElementById('import-modal').style.display='none'" class="btn btn-secondary">取消</button>
                <button id="import-json-confirm-btn" class="btn btn-primary">确认还原</button>
            </div>
        </div>
    </div>

    <script type="module">
        try {
            // === Firebase Initialization ===
            const firebaseConfig = {
                apiKey: "AIzaSyBgYSM_HCYqUSvIN5VifHbX-j9p6IjhVJs",
                authDomain: "sample-firebase-ai-app-87f8f.firebaseapp.com",
                projectId: "sample-firebase-ai-app-87f8f",
                storageBucket: "sample-firebase-ai-app-87f8f.firebasestorage.app",
                messagingSenderId: "887928734431",
                appId: "1:887928734431:web:348a48ea1cde4a932cdf6a"
            };
            // FIX: Use the global `firebase` object provided by the script tags in <head>
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth.getAuth(app);
            const db = firebase.firestore.getFirestore(app);
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            
            // === State & UI Elements ===
            let currentUser = null;
            let localStudentsData = [];
            let selectedStudentId = null;
            let chartInstances = {};
            const ui = {
                loginView: document.getElementById('login-view'),
                appView: document.getElementById('app-view'),
                loadingOverlay: document.getElementById('loading-overlay'),
                errorContainer: document.getElementById('error-container'),
                statusMessage: document.getElementById('status-message'),
                tabNav: document.getElementById('tab-nav'),
                tabContent: document.getElementById('tab-content'),
                coursesTab: document.getElementById('courses-tab'),
                analyticsTab: document.getElementById('analytics-tab'),
                gpaTab: document.getElementById('gpa-tab'),
                studentContentContainer: document.getElementById('student-content-container'),
                searchInput: document.getElementById('search-input'),
                addSemesterBtn: document.getElementById('add-semester-btn'),
                coursesEmptyState: document.getElementById('courses-empty-state'),
                analyticsContent: document.getElementById('analytics-content'),
                analyticsEmptyState: document.getElementById('analytics-empty-state'),
                radarChart: document.getElementById('radar-chart'),
                barChart: document.getElementById('bar-chart'),
                calculateGpaBtn: document.getElementById('calculate-gpa'),
                gpaInputs: document.getElementById('gpa-inputs'),
                addGpaRowBtn: document.getElementById('add-gpa-row'),
                totalCredits: document.getElementById('total-credits'),
                weightedScore: document.getElementById('weighted-score'),
                averageScore: document.getElementById('average-score'),
                gpaResult: document.getElementById('gpa-result'),
                themeToggle: document.getElementById('theme-toggle'),
                themeIcon: document.getElementById('theme-icon'),
                lightPath: document.getElementById('light-path'),
                darkPath: document.getElementById('dark-path'),
                studentMenu: {
                    btn: document.getElementById('student-menu-btn'),
                    options: document.getElementById('student-menu-options'),
                    list: document.getElementById('student-options-list'),
                    currentName: document.getElementById('current-student-name-display'),
                    addBtn: document.getElementById('add-student-btn'),
                    manageBtn: document.getElementById('manage-students-btn')
                },
                userMenu: {
                    btn: document.getElementById('user-menu-btn'),
                    options: document.getElementById('user-menu-options'),
                    displayName: document.getElementById('user-display-name'),
                    avatar: document.getElementById('user-avatar')
                },
                confirmModal: {
                    el: document.getElementById('confirm-modal'),
                    title: document.getElementById('confirm-modal-title'),
                    body: document.getElementById('confirm-modal-body'),
                    cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
                    confirmBtn: document.getElementById('confirm-modal-confirm-btn')
                },
                importModal: {
                    el: document.getElementById('import-modal'),
                    fileInput: document.getElementById('import-json-file-input'),
                    confirmBtn: document.getElementById('import-json-confirm-btn')
                },
                exportJsonBtn: document.getElementById('export-json-btn'),
                exportXlsxBtn: document.getElementById('export-xlsx'),
                importJsonBtn: document.getElementById('import-json-btn'),
                logoutBtn: document.getElementById('logout-btn'),
                googleLoginBtn: document.getElementById('google-login-btn')
            };

            // === Utility Functions ===
            function showError(message, details = null) {
                const errorId = `error-${Date.now()}`;
                const errorDiv = document.createElement('div');
                errorDiv.id = errorId;
                errorDiv.className = 'error-message mb-2 fade-in bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative';
                errorDiv.innerHTML = `<strong class="font-bold">Error:</strong><span class="block sm:inline"> ${message}</span>${details ? `<div class="mt-2 text-sm">${details}</div>` : ''}<span class="absolute top-0 bottom-0 right-0 px-4 py-3"><svg onclick="document.getElementById('${errorId}').remove()" class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.818l-2.651 3.031a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg></span>`;
                ui.errorContainer.appendChild(errorDiv);
                setTimeout(() => { errorDiv.remove(); }, 6000);
            }

            function showSuccess(message) {
                const successId = `success-${Date.now()}`;
                const successDiv = document.createElement('div');
                successDiv.id = successId;
                successDiv.className = 'fade-in p-4 mb-2 rounded-lg bg-green-50 border border-green-200 text-green-800 dark:bg-green-900/30 dark:border-green-700 dark:text-green-300';
                successDiv.innerHTML = `<div class="flex justify-between items-center"><span><strong>Success:</strong> ${message}</span><button onclick="document.getElementById('${successId}').remove()" class="text-lg font-bold text-green-600">&times;</button></div>`;
                ui.errorContainer.appendChild(successDiv);
                setTimeout(() => { successDiv.remove(); }, 3000);
            }

            function scoreToGpaPoint(score) {
                if (score >= 90) return 4.0; if (score >= 85) return 3.7; if (score >= 82) return 3.3;
                if (score >= 78) return 3.0; if (score >= 75) return 2.7; if (score >= 72) return 2.3;
                if (score >= 68) return 2.0; if (score >= 64) return 1.5; if (score >= 60) return 1.0;
                return 0.0;
            }

            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            const debouncedUpdater = debounce(() => {
                const student = localStudentsData.find(s => s.id === selectedStudentId);
                if (student) updateStudentData(student.semesters);
            }, 800);

            // === Core Logic ===
            function updateAllCalculations(student) {
                if (!student) return null;
                const studentCopy = JSON.parse(JSON.stringify(student));
                studentCopy.semesters.forEach(semester => {
                    let totalCredits = 0;
                    let weightedScoreSum = 0;
                    let gpaPointsSum = 0;
                    (semester.courses || []).forEach(course => {
                        const credits = parseFloat(course.credits) || 0;
                        let currentWeightedScore = 0;
                        let totalWeight = 0;
                        (course.assignments || []).forEach(a => {
                            const weight = parseFloat(a.weight) || 0;
                            totalWeight += weight;
                            if (a.score !== '' && a.score !== null && a.score !== undefined) {
                                const score = parseFloat(a.score) || 0;
                                const maxScore = parseFloat(a.maxScore) || 100;
                                currentWeightedScore += (score / maxScore) * weight;
                            }
                        });
                        // Normalize the final grade if total weight is not 100
                        course.finalGrade = (totalWeight > 0 && totalWeight !== 100) 
                            ? parseFloat((currentWeightedScore / totalWeight * 100).toFixed(2))
                            : parseFloat(currentWeightedScore.toFixed(2));

                        if (credits > 0) {
                            totalCredits += credits;
                            const gpaPoint = scoreToGpaPoint(course.finalGrade);
                            gpaPointsSum += gpaPoint * credits;
                            weightedScoreSum += course.finalGrade * credits;
                        }
                    });
                    semester.totalCredits = totalCredits;
                    semester.gpa = totalCredits > 0 ? parseFloat((gpaPointsSum / totalCredits).toFixed(2)) : 0;
                    semester.averageScore = totalCredits > 0 ? parseFloat((weightedScoreSum / totalCredits).toFixed(2)) : 0;
                });

                // Calculate overall stats
                const allCourses = studentCopy.semesters.flatMap(s => s.courses || []);
                const overallTotalCredits = allCourses.reduce((sum, c) => sum + (parseFloat(c.credits) || 0), 0);
                const overallGpaPointsSum = allCourses.reduce((sum, c) => {
                    const credits = parseFloat(c.credits) || 0;
                    return sum + scoreToGpaPoint(c.finalGrade) * credits;
                }, 0);
                const overallWeightedScoreSum = allCourses.reduce((sum, c) => sum + (c.finalGrade * (parseFloat(c.credits) || 0)), 0);
                studentCopy.overallGpa = overallTotalCredits > 0 ? parseFloat((overallGpaPointsSum / overallTotalCredits).toFixed(2)) : 0;
                studentCopy.overallAverageScore = overallTotalCredits > 0 ? parseFloat((overallWeightedScoreSum / overallTotalCredits).toFixed(2)) : 0;

                return studentCopy;
            }

            // === Rendering Functions ===
            function renderStudentSelector() {
                ui.studentMenu.list.innerHTML = '';
                localStudentsData.forEach(student => {
                    const li = document.createElement('li');
                    const button = document.createElement('button');
                    button.className = 'w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm';
                    button.textContent = student.name;
                    button.dataset.studentId = student.id;
                    li.appendChild(button);
                    ui.studentMenu.list.appendChild(li);
                });
                const currentStudent = localStudentsData.find(s => s.id === selectedStudentId);
                ui.studentMenu.currentName.textContent = currentStudent ? currentStudent.name : '选择学生';
            }
            
            function renderStudentContent(student, searchTerm = '') {
                ui.studentContentContainer.innerHTML = '';
                const hasData = student && student.semesters && student.semesters.length > 0;
                ui.coursesEmptyState.classList.toggle('hidden', hasData);
                ui.studentContentContainer.classList.toggle('hidden', !hasData);

                if (!hasData) return;

                student.semesters.forEach((semester) => {
                    const semesterEl = document.createElement('div');
                    semesterEl.className = 'card p-4';
                    semesterEl.dataset.semesterId = semester.id;
                    semesterEl.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <button class="drag-handle text-gray-400 hover:text-gray-600 cursor-move" data-action="drag-semester">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                                </button>
                                <h2 class="text-xl font-semibold">${semester.name}</h2>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs sm:text-sm text-gray-500">总学分: ${semester.totalCredits || 0}</span>
                                <span class="text-xs sm:text-sm text-gray-500">均分: ${semester.averageScore || 0}</span>
                                <span class="text-xs sm:text-sm font-medium bg-indigo-100 text-indigo-700 px-2 py-1 rounded">GPA: ${semester.gpa || 0}</span>
                                <button class="text-red-500 hover:text-red-700 p-1" data-action="delete-semester">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-4 courses-container">
                            ${(semester.courses || []).map((course) => `
                                <div class="border-l-4 border-indigo-500 pl-4" data-course-id="${course.id}">
                                    <div class="flex items-center justify-between mb-2">
                                        <h3 class="font-medium">${course.name} <span class="text-sm text-gray-500">(${course.credits || 0} 学分)</span></h3>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm text-gray-500">最终: ${course.finalGrade || 0}</span>
                                            <button class="text-red-500 hover:text-red-700 p-1" data-action="delete-course">
                                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                                            <h4 class="text-sm font-medium mb-2">作业列表</h4>
                                            <div class="space-y-2 assignments-container">
                                                ${(course.assignments || []).map((a, aIndex) => `
                                                    <div class="flex items-center space-x-2" data-assignment-index="${aIndex}">
                                                        <input type="text" value="${a.name || ''}" placeholder="作业名" class="input text-sm w-24" data-field="name" data-action="update-assignment">
                                                        <input type="number" value="${a.maxScore || 100}" placeholder="满分" class="input text-sm w-20" data-field="maxScore" data-action="update-assignment">
                                                        <input type="number" value="${a.score || ''}" placeholder="得分" class="input text-sm w-20" data-field="score" data-action="update-assignment">
                                                        <input type="number" value="${a.weight || 0}" placeholder="权重%" class="input text-sm w-20" data-field="weight" data-action="update-assignment">
                                                        <button class="text-red-500 hover:text-red-700 p-1" data-action="delete-assignment">
                                                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <button class="btn btn-secondary text-sm mt-2" data-action="add-assignment">+ 添加作业</button>
                                        </div>
                                        <div class="flex items-center justify-center"><canvas id="doughnut-${course.id}" width="120" height="120"></canvas></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn btn-secondary text-sm mt-2" data-action="add-course">+ 添加课程</button>
                    `;
                    ui.studentContentContainer.appendChild(semesterEl);
                    (semester.courses || []).forEach(course => {
                        const canvas = document.getElementById(`doughnut-${course.id}`);
                        if (canvas) renderCourseWeightDoughnutChart(canvas, course);
                    });
                });
            }
            
            function renderCourseWeightDoughnutChart(canvas, course) { /* Placeholder for chart logic */ }
            function renderCoursePerformanceRadarChart(canvas, studentData) { /* Placeholder for chart logic */ }
            function renderGradeCreditDistributionBarChart(canvas, studentData) { /* Placeholder for chart logic */ }
            function renderAnalyticsTab(student) {
                 if (!student || !student.semesters || student.semesters.length === 0) {
                    ui.analyticsContent.classList.add('hidden');
                    ui.analyticsEmptyState.classList.remove('hidden');
                    return;
                }
                ui.analyticsContent.classList.remove('hidden');
                ui.analyticsEmptyState.classList.add('hidden');
                renderCoursePerformanceRadarChart(ui.radarChart, student);
                renderGradeCreditDistributionBarChart(ui.barChart, student);
            }

            // === Event Listeners ===
            function setupEventListeners() {
                // Tab switching
                ui.tabNav.addEventListener('click', (e) => {
                    const tabButton = e.target.closest('.tab');
                    if (tabButton) {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
                        tabButton.classList.add('active');
                        const tabId = tabButton.dataset.tab;
                        document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                        if (tabId === 'analytics') {
                            const student = localStudentsData.find(s => s.id === selectedStudentId);
                            renderAnalyticsTab(student);
                        }
                    }
                });

                // Search
                ui.searchInput.addEventListener('input', debounce((e) => renderApp(e.target.value), 300));

                // Add Semester
                ui.addSemesterBtn.addEventListener('click', async () => {
                    const student = localStudentsData.find(s => s.id === selectedStudentId);
                    if (!student) return;
                    const name = prompt('请输入学期名称:', `学期 ${student.semesters.length + 1}`);
                    if (!name || !name.trim()) return;
                    const newSemester = { id: `sem-${Date.now()}`, name: name.trim(), courses: [], order: student.semesters.length };
                    student.semesters.push(newSemester);
                    await updateStudentData(student.semesters);
                });

                // Event Delegation for dynamic content
                ui.studentContentContainer.addEventListener('click', async (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    
                    const student = localStudentsData.find(s => s.id === selectedStudentId);
                    if (!student) return;

                    const semesterEl = button.closest('.card[data-semester-id]');
                    const semesterId = semesterEl?.dataset.semesterId;
                    const semester = student.semesters.find(s => s.id === semesterId);

                    const courseEl = button.closest('div[data-course-id]');
                    const courseId = courseEl?.dataset.courseId;
                    const course = semester?.courses.find(c => c.id === courseId);

                    const assignmentEl = button.closest('div[data-assignment-index]');
                    const assignmentIndex = assignmentEl?.dataset.assignmentIndex;

                    const action = button.dataset.action;

                    switch (action) {
                        case 'add-course': {
                            const name = prompt('请输入课程名称:');
                            if (!name || !name.trim()) return;
                            const credits = parseFloat(prompt('请输入学分:', '3')) || 3;
                            const newCourse = { id: `course-${Date.now()}`, name: name.trim(), credits, assignments: [] };
                            if (!semester.courses) semester.courses = [];
                            semester.courses.push(newCourse);
                            await updateStudentData(student.semesters);
                            break;
                        }
                        case 'add-assignment': {
                            const name = prompt('请输入作业名称:', `作业 ${(course.assignments || []).length + 1}`);
                            if (!name || !name.trim()) return;
                            if (!course.assignments) course.assignments = [];
                            course.assignments.push({ name: name.trim(), maxScore: 100, weight: 10, score: '' });
                            await updateStudentData(student.semesters);
                            break;
                        }
                        case 'delete-semester':
                            if (confirm('确定要删除这个学期吗？')) {
                                student.semesters = student.semesters.filter(s => s.id !== semesterId);
                                await updateStudentData(student.semesters);
                            }
                            break;
                        case 'delete-course':
                            if (confirm('确定要删除这门课程吗？')) {
                                semester.courses = semester.courses.filter(c => c.id !== courseId);
                                await updateStudentData(student.semesters);
                            }
                            break;
                        case 'delete-assignment':
                            if (confirm('确定要删除这项作业吗？')) {
                                course.assignments.splice(assignmentIndex, 1);
                                await updateStudentData(student.semesters);
                            }
                            break;
                    }
                });

                ui.studentContentContainer.addEventListener('change', (e) => {
                    const input = e.target.closest('input[data-action="update-assignment"]');
                    if (!input) return;

                    const student = localStudentsData.find(s => s.id === selectedStudentId);
                    const semester = student.semesters.find(s => s.id === input.closest('.card[data-semester-id]').dataset.semesterId);
                    const course = semester.courses.find(c => c.id === input.closest('div[data-course-id]').dataset.courseId);
                    const assignment = course.assignments[input.closest('div[data-assignment-index]').dataset.assignmentIndex];
                    
                    const field = input.dataset.field;
                    const value = input.type === 'number' ? (isNaN(input.valueAsNumber) ? '' : input.valueAsNumber) : input.value;
                    
                    if (assignment) {
                        assignment[field] = value;
                        debouncedUpdater();
                    }
                });
                
                // Student Menu
                ui.studentMenu.btn.addEventListener('click', () => ui.studentMenu.options.classList.toggle('hidden'));
                ui.studentMenu.list.addEventListener('click', (e) => {
                     const button = e.target.closest('button');
                     if(button && button.dataset.studentId) {
                        selectedStudentId = button.dataset.studentId;
                        localStorage.setItem('selectedStudentId', selectedStudentId);
                        renderApp();
                        ui.studentMenu.options.classList.add('hidden');
                     }
                });
                ui.studentMenu.addBtn.addEventListener('click', async () => { /* ... existing logic ... */ });
                
                // User Menu & Auth
                ui.userMenu.btn.addEventListener('click', () => ui.userMenu.options.classList.toggle('hidden'));
                ui.googleLoginBtn.addEventListener('click', () => {
                    firebase.auth().signInWithPopup(provider).catch(error => showError('登录失败', error.message));
                });
                ui.logoutBtn.addEventListener('click', () => firebase.auth().signOut().catch(error => showError('退出失败', error.message)));
                
                // Other event listeners (GPA, Theme, etc.) would go here...
            }

            async function updateStudentData(updatedSemesters) {
                if (!selectedStudentId || !currentUser) return;
                const studentDocRef = firebase.firestore.doc(db, 'users', currentUser.uid, 'students', selectedStudentId);
                try {
                    await firebase.firestore.updateDoc(studentDocRef, { semesters: updatedSemesters });
                    showSuccess('数据已同步!');
                } catch (error) {
                    showError('数据同步失败', error.message);
                }
            }

            function renderApp(searchTerm = '') {
                const student = localStudentsData.find(s => s.id === selectedStudentId);
                renderStudentSelector();
                if (student) {
                    const studentWithCalculations = updateAllCalculations(student);
                    renderStudentContent(studentWithCalculations, searchTerm);
                } else {
                    renderStudentContent(null);
                }
            }

            // === Initialization ===
            firebase.auth().onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    ui.loginView.classList.add('hidden');
                    ui.appView.classList.remove('hidden');
                    ui.userMenu.displayName.textContent = user.displayName || 'User';
                    ui.userMenu.avatar.src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'U')}`;

                    const savedStudentId = localStorage.getItem('selectedStudentId');
                    const q = firebase.firestore.query(firebase.firestore.collection(db, 'users', user.uid, 'students'));
                    
                    firebase.firestore.onSnapshot(q, (snapshot) => {
                        localStudentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        localStudentsData.sort((a, b) => (a.order || 0) - (b.order || 0));
                        
                        if (!selectedStudentId || !localStudentsData.some(s => s.id === selectedStudentId)) {
                            selectedStudentId = savedStudentId && localStudentsData.some(s => s.id === savedStudentId) ? savedStudentId : localStudentsData[0]?.id || null;
                        }
                        
                        if (selectedStudentId) localStorage.setItem('selectedStudentId', selectedStudentId);
                        
                        renderApp();
                        ui.loadingOverlay.style.display = 'none';
                    }, (error) => {
                        showError('数据加载失败', error.message);
                        ui.loadingOverlay.style.display = 'none';
                    });

                } else {
                    ui.loginView.classList.remove('hidden');
                    ui.appView.classList.add('hidden');
                    localStudentsData = [];
                    selectedStudentId = null;
                    ui.loadingOverlay.style.display = 'none';  
                }
            });

            setupEventListeners();

        } catch (error) {
            console.error("Initialization failed:", error);
            document.getElementById('loading-overlay').style.display = 'none';
            const errorDiv = document.createElement('div');
            errorDiv.className = 'p-4 bg-red-100 text-red-800 rounded';
            errorDiv.textContent = `Application failed to load: ${error.message}`;
            document.body.prepend(errorDiv);
        }
    </script>
</body>
</html>
